---
import Layout from "../../layouts/Layout.astro";
import { createGoogleGenerativeAI } from "@ai-sdk/google";
import { generateText } from "ai";
import { action } from "../../utils/form";
import { GOOGLE_API_KEY } from "astro:env/server";

const googleGenerativeAI = createGoogleGenerativeAI({
	apiKey: GOOGLE_API_KEY,
});
const model = googleGenerativeAI("gemini-1.5-flash");

// Use the action utility to handle form submissions
const { data, response } = await action(Astro, async () => {
	const formData = await Astro.request.formData();
	const text = formData.get("text");
	const emojiCount = formData.get("emojiCount") || "auto";

	if (!text || typeof text !== "string") {
		return { error: "No text provided", result: "" };
	}

	try {
		const response = await generateText({
			model: model,
			prompt: `You are an emoji suggester.
You will be given a text and a number of emojis you should suggest.


Guidelines:
- The number may be "auto" or a number. If it is "auto", you should suggest as many emojis as possible to describe the text. If it is a number, you should suggest that many emojis.
- Only include the emojis in your response ALWAYS.
- NEVER INCLUDE TEXT IN YOUR RESPONSE.

Example:
Text: I'm so happy to see you!
Emoji count: 2
Response: ğŸ˜ŠğŸ‘‹

Text: Hello, world!
Emoji count: 2
Response: ğŸŒğŸ‘‹

Text: I'm so happy to see you!
Emoji count: auto
Response: ğŸ˜ŠğŸ‘‹

Text: Today I built a new website!
Emoji count: 1
Response: ğŸŒ

Text: ${text}
Emoji count: ${emojiCount}`,
			maxTokens: 50,
		});

		return { error: "", result: response?.text };
	} catch (apiError) {
		console.error("Error generating emoji suggestions:", apiError);
		return { error: "Failed to generate emoji suggestions", result: "" };
	}
});

// Early return for client-side requests
if (response) return response;

// Extract data for server-side rendering
const error = data?.error || "";
const result = data?.result || "";
---

<Layout seo={{ title: "EmojiSense - AI-powered Emoji Suggestions" }}>
  <div class="max-w-[700px] mx-auto">
    <h1 class="text-3xl font-bold mb-4 text-center">
      <span class="underline-animation">Emoji</span>Sense
    </h1>

    <div class="flex justify-center items-center flex-col gap-2 my-5">
      <p>Get AI-powered emoji suggestions for your text.</p>
    </div>

    <div class="card p-6">
      <form method="POST" id="emojiForm">
        <div class="mb-4">
          <label for="text" class="block text-sm font-medium mb-1">
            Enter your text (max 500 characters)
          </label>
          <textarea
            id="text"
            name="text"
            rows="4"
            maxlength="500"
            placeholder="Type your text here..."
            class="w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
          ></textarea>
          <p class="text-xs text-gray-500 mt-1" id="charCount">0/500 characters</p>
        </div>
        
        <div class="mb-4">
          <label for="emojiCount" class="block text-sm font-medium mb-1">
            Number of emojis
          </label>
          <select
            id="emojiCount"
            name="emojiCount"
            class="w-full rounded-md border border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
          >
            <option value="auto">Auto</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
        </div>
        
        <div class="flex justify-end">
        <button 
          type="submit" 
          id="submitBtn"
          class="btn"
          disabled
          >
            Suggest Emojis
          </button>
        </div>
      </form>
      
      <div class="mt-6">
        <h2 class="text-lg font-semibold mb-2">Suggested Emojis</h2>
        <div id="result" class="h-16 flex items-center justify-center">
          <div data-form-id="error" class="text-red-500">{error}</div>
          <div data-form-id="result" class="text-4xl transition-all duration-300 ease-in-out">{result}</div>
          {!error && !result && (
            <div class="text-center text-gray-500" data-empty-state>
              Your suggested emojis will appear here
            </div>
          )}
        </div>
      </div>
    </div>
    
    <div class="card p-6 mt-6">
      <h2 class="font-bold text-lg mb-4">How it works</h2>
      <p>EmojiSense uses advanced AI to analyze your text and suggest the most appropriate emojis. The algorithm considers:</p>
      <ul class="list-disc list-inside space-y-2 mt-2">
        <li>The sentiment of your message</li>
        <li>Key topics and themes</li>
        <li>Context and intended audience</li>
      </ul>
      <p class="mt-4">You can specify how many emojis you want, or let the AI decide the optimal number.</p>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const textArea = document.getElementById('text') as HTMLTextAreaElement;
    const charCount = document.getElementById('charCount') as HTMLElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const form = document.getElementById('emojiForm') as HTMLFormElement;
    const resultContainer = document.getElementById('result');
    const emptyState = document.querySelector('[data-empty-state]');
    
    if (textArea) {
      textArea.addEventListener('input', () => {
        const count = textArea.value.length;
        charCount.textContent = `${count}/500 characters`;
        
        // Enable/disable submit button based on text content
        submitBtn.disabled = count === 0;
      });
    }
    
    // Progressive enhancement for form submission
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Loading...';
        
        fetch(window.location.href, {
          method: 'POST',
          body: new FormData(form),
          headers: {
            accept: 'application/json',
          }
        })
        .then(res => res.json())
        .then(data => {
          // Update the DOM with response data
          const errorEl = document.querySelector('[data-form-id="error"]');
          const resultEl = document.querySelector('[data-form-id="result"]');
          
          if (errorEl) {
            errorEl.textContent = data.error || '';
            errorEl.style.display = data.error ? 'block' : 'none';
          }
          
          if (resultEl) {
            resultEl.textContent = data.result || '';
            resultEl.style.display = data.result ? 'block' : 'none';
          }
          
          // Show/hide empty state
          if (emptyState) {
            emptyState.style.display = !data.error && !data.result ? 'block' : 'none';
          }
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = 'Suggest Emojis';
        })
        .catch(error => {
          console.error('Error:', error);
          
          // Handle fetch errors
          const errorEl = document.querySelector('[data-form-id="error"]');
          if (errorEl) {
            errorEl.textContent = 'Network error occurred. Please try again.';
            errorEl.style.display = 'block';
          }
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = 'Suggest Emojis';
        });
      });
    }
  });
</script>