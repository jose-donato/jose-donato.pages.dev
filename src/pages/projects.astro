---
import Layout from "../layouts/Layout.astro";
import Icon from "../components/Icon.astro";
import { PROJECTS, TOOLS } from "../utils/constants";

const technologies = Array.from(
    new Set(PROJECTS.flatMap((project) => project.technologies)),
);
const url = new URL(Astro.request.url);
const query = url.searchParams.get("q") || "";
const filteredProjects = query
    ? PROJECTS.filter((project) => project.technologies.includes(query))
    : PROJECTS;

// Fetch GitHub stars for projects with GitHub URLs
const projectsWithStars = await Promise.all(
    filteredProjects.map(async (project) => {
        // Check if the URL is a GitHub repository URL
        if (project.url?.includes("github.com")) {
            try {
                // Extract owner and repo from GitHub URL
                const urlParts = new URL(project.url).pathname
                    .split("/")
                    .filter(Boolean);
                if (urlParts.length >= 2) {
                    const owner = urlParts[0];
                    const repo = urlParts[1];

                    // Fetch star count from GitHub API
                    const response = await fetch(
                        `https://api.github.com/repos/${owner}/${repo}`,
                    );
                    if (response.ok) {
                        const data = await response.json();
                        return { ...project, stars: data.stargazers_count };
                    }
                }
            } catch (error) {
                console.error(
                    `Error fetching stars for ${project.title}:`,
                    error,
                );
            }
        }
        return project;
    }),
);
---

<Layout>
    <div class="space-y-20">
        <!-- Tools Section -->
        <section>
            <div class="flex items-center gap-3 mb-8">
                <div
                    class="w-8 h-8 bg-bullish-500/10 rounded-lg flex items-center justify-center"
                >
                    <Icon
                        id="material-symbols-build"
                        className="w-4 h-4 text-bullish-400"
                    />
                </div>
                <h1 class="text-2xl font-bold">Tools</h1>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {
                    TOOLS.map((tool) => {
                        // Assign icons based on tool type
                        let iconId = "material-symbols-build";
                        if (tool.title.includes("Sprite")) {
                            iconId = "material-symbols-extension";
                        } else if (tool.title.includes("EmojiSense")) {
                            iconId = "material-symbols-psychology";
                        } else if (tool.title.includes("BTC")) {
                            iconId = "bitcoin-logo";
                        } else if (tool.title.includes("Gift")) {
                            iconId = "material-symbols-lightbulb-outline";
                        } else if (tool.title.includes("Quiz")) {
                            iconId = "material-symbols-playlist-add-check";
                        }

                        return (
                            <div class="card group flex flex-col">
                                {/* Content Section */}
                                <div class="flex items-center gap-3 mb-3">
                                    <h2 class="font-bold">
                                        {tool.title}
                                    </h2>
                                </div>
                                <p class="text-sm mb-4">
                                    {tool.description}
                                </p>

                                <a
                                    href={`/tools/${tool.slug}`}
                                    class="inline-flex items-center gap-2 text-sm link mt-auto self-end"
                                >
                                    Try it out
                                </a>
                            </div>
                        );
                    })
                }
            </div>
        </section>

        <!-- Projects Section -->
        <section>
            <div class="flex items-center gap-3 mb-8">
                <div
                    class="w-8 h-8 bg-bullish-500/10 rounded-lg flex items-center justify-center"
                >
                    <Icon
                        id="material-symbols-code"
                        className="w-4 h-4 text-bullish-400"
                    />
                </div>
                <h1 class="text-2xl font-bold">Projects</h1>
            </div>

            {/* Filter Section */}
            <div class="mb-8">
                <form class="space-y-2">
                    <div class="flex flex-wrap gap-2">
                        {
                            technologies.map((tech) => (
                                <button
                                    type="submit"
                                    name="q"
                                    value={tech}
                                    class={
                                        query === tech ? "btn" : "btn-outline"
                                    }
                                >
                                    {tech}
                                </button>
                            ))
                        }
                    </div>
                    {
                        query && (
                            <button
                                class="btn gap-2 ml-auto"
                                type="submit"
                                name="q"
                                value=""
                            >
                                <Icon
                                    id="system-uicons-reset"
                                    className="w-4 h-4"
                                />
                                Reset
                            </button>
                        )
                    }
                </form>
            </div>

            {/* Projects Grid */}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {
                    projectsWithStars.map((project) => {
                        // Assign icons based on project type
                        let iconId = "material-symbols-code";
                        if (project.type === "website") {
                            iconId = "material-symbols-web";
                        } else if (project.type === "mobile app") {
                            iconId = "material-symbols-smartphone";
                        } else if (project.type === "browser extension") {
                            iconId = "material-symbols-extension";
                        } else if (project.type === "desktop app") {
                            iconId = "material-symbols-build";
                        } else if (project.type === "web app") {
                            iconId = "material-symbols-web";
                        }

                        return (
                            <div class="card group flex flex-col">
                                {/* Content Section */}
                                <div class="flex items-center gap-3 mb-3 justify-between">
                                    <div class="flex items-center gap-2">
                                        <h2 class="font-bold">
                                            {project.title}
                                        </h2>
                                    </div>
                                    <div class="">
                                        <p class="date">{project.type}</p>
                                    </div>
                                </div>

                                <p class="text-sm mb-2">
                                    Technologies used:{" "}
                                    {project.technologies.join(", ")}
                                </p>
                                <p class="text-sm mb-4">
                                    {project.description}
                                </p>

                                <div class="flex justify-between items-center mt-auto">
                                    <div>
                                        {project.stars !== undefined && (
                                            <a
                                                href={project.url}
                                                target="_blank"
                                                rel="noreferrer noopener"
                                                class="flex items-center gap-1 text-sm"
                                            >
                                                <Icon
                                                    id="material-symbols-light-kid-star-sharp"
                                                    className="w-4 h-4 text-yellow-400"
                                                />
                                                <span>{project.stars}</span>
                                            </a>
                                        )}
                                    </div>
                                    <a
                                        href={project.url}
                                        rel="noreferrer noopener"
                                        target="_blank"
                                        class="inline-flex items-center gap-2 text-sm link mt-auto self-end"
                                    >
                                        View project
                                    </a>
                                </div>
                            </div>
                        );
                    })
                }
            </div>
        </section>
    </div>
</Layout>
